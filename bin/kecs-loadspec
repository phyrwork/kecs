#!/bin/bash
set -e

# output fields
[ $# -lt 1 ] && echo "error: table not specified" >&2 && exit 2
out=$(kecs-schema "$1" | tr ',' ' ')

# input fields
[ $# -lt 2 ] && echo "error: data file not specified" >&2 && exit 1
in=$(cat $2 | head -n 1 | tr ',' '\n')

# find entry in array
contains () {
    local e match="$1"
    shift
    for e; do [[ "$e" == "$match" ]] && return 0; done
    return 1
}

# create and print spec
spec=()
# each input field
for fld in $in; do
  # filter by output fields
  if contains $fld $out; then
    spec+=("@$fld")
  else
    spec+=("@_dummy${#spec[@]}")
  fi
done
echo $(IFS=,; echo "${spec[*]}")
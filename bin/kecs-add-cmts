#!/bin/bash
set -e

# TODO: cli opts and env vars
db=kecs
tbl=posts
users=users

# set input
# mysql/mariadb can take /dev/stdin as a filename for load data
# if no files given, default to stdin - set positional args
[ $# -lt 1 ] && set -- /dev/stdin

for file in "$@"; do
  # load stmt
  spec=$(kecs-loadspec comments "$file")
  sql="\
CREATE TEMPORARY TABLE IF NOT EXISTS raw (
  id bigint(11) unsigned NOT NULL,
  link bigint(11) unsigned NOT NULL,
  parent bigint(11) unsigned NOT NULL,
  created int(11) unsigned NOT NULL,
  username char(20) NOT NULL,
  score int(11) NOT NULL,
  PRIMARY KEY (id),
  KEY (username) USING BTREE
) DEFAULT CHARSET=utf8mb4;
--
LOAD DATA LOCAL INFILE '$file'
INTO TABLE raw
FIELDS TERMINATED BY ',' ENCLOSED BY '\"' ESCAPED BY '\"'
LINES TERMINATED BY '\\n'
IGNORE 1 LINES
($spec)
SET
  id = CONV(@id,36,10),
  link = CONV(SUBSTRING(@link_id FROM 4),36,10),
  parent = CONV(SUBSTRING(@parent_id FROM 4),36,10),
  username = @author,
  created = @created_utc,
  score = @score;
--
INSERT INTO users(username)
SELECT DISTINCT username FROM raw
ON DUPLICATE KEY UPDATE id=users.id,username=users.username;
--
INSERT INTO $tbl(id,link,parent,user,created,score)
SELECT r.id,r.link,r.parent,u.id,r.created,r.score
FROM raw AS r
INNER JOIN $users AS u ON r.username = u.username
ON DUPLICATE KEY UPDATE id=$tbl.id;
"
  # import
  echo "importing comments from $file" >&2
  mysql "$db" -e "$sql"
done

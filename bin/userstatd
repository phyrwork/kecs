#!/bin/bash
set -e

db=kecs
name=$1

sql="\
WITH RECURSIVE descs(id, link, parent, score)
AS (
	SELECT id, link, parent, score
	FROM posts
	WHERE user IN (
	    SELECT id FROM users WHERE name = '$name'
	)
	UNION ALL
	SELECT p.id, p.link, p.parent, p.score
	FROM posts AS p
	INNER JOIN descs AS d
      ON d.link = p.link AND d.parent = p.id
)
SELECT COUNT(*) AS count, SUM(d.score) AS score
FROM descs AS d;
"

mysql -N $db <<< $sql


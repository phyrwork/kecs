#!/bin/bash
set -e

function rmecho {
    rm "$1"
    echo "deleted $1" >&2
}

db=kecs
tbl="posts"
users="users"

while [ $# -gt 0 ]; do
    case $1 in
        -t) tbl=$2 && shift 2;;
        -u) users=$2 && shift 2;;
        -D) del=1 && shift;;
        *)  break;;
    esac
done

if [ $# -gt 0 ]; then
    files=$(mktemp -u)
    printf '%s\n' $@ > $files
    trap "rm $files" EXIT
    exec 0< $files
fi

while read file; do

    # preload users
    addusers -t $users -n author $file

    spec=$(colspec -v id -v created_utc -v author -c score $file)

    sql="\
CREATE TEMPORARY TABLE IF NOT EXISTS raw (
    id bigint(11) unsigned NOT NULL,
    created int(11) unsigned NOT NULL,
    username char(20) NOT NULL,
    score int(11) NOT NULL,
    PRIMARY KEY (id),
    KEY (username) USING BTREE
) DEFAULT CHARSET=utf8mb4;

LOAD DATA LOCAL INFILE '$file'
IGNORE INTO TABLE raw
FIELDS TERMINATED BY ',' ENCLOSED BY '\"' ESCAPED BY '\"'
LINES TERMINATED BY '\\n'
IGNORE 1 LINES
($spec)
SET
    id = CONV(@id,36,10),
    username = @author,
    created = @created_utc;

INSERT INTO $tbl(id,link,parent,user,created,score)
SELECT r.id,r.id,0,u.id,r.created,r.score
FROM raw AS r INNER JOIN users AS u ON r.username = u.name;
"

    # import
    echo "importing submissions from $file" >&2
    mysql $db <<< $sql

    # optionally delete imported files
    [ -z $del ] || rmecho $file
done

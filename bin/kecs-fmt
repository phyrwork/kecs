#!/bin/bash
set -e

# clean up on exit
tmp=()
rmexit () {
  tmp+=($1)
  trap "rm ${tmp[*]}" EXIT
}

# gather options
while [ $# -gt 0 ]; do
    case $1 in
        -z) archive=$2 && shift 2;;
        -e) extract=$2 && shift 2;;
        -o) prefix=$2 && shift 2;;
        -N) size=$2 && shift 2;;
        *)  break;;
    esac
done

# set input
# replace stdin with file if given
[ $# -lt 1 ] || exec 0< "$1"

# inflate
if [ -n "$archive" ]; then
  # TODO: figure out how to call rmexit() from a function that doesn't trigger EXIT
  json=$(mktemp -u)
  mkfifo "$json"
  rmexit "$json"
  kecs-inflate "$archive" | tee "$json" >/dev/null &
  exec 0< "$json"
fi

# extract
if [ -n "$extract" ]; then
  csv=$(mktemp -u)
  mkfifo "$csv"
  rmexit "$csv"
  kecs-extract "$extract" | tee "$csv" >/dev/null &
  exec 0< "$csv"
fi

# split
if [ -n "$size" ]; then
  kecs-split "$size" - ${prefix:-}
else
  cat
fi